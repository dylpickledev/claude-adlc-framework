
---

## Enhanced /switch Command Implementation (2025-10-15)

PATTERN: Extended thinking block preservation for reasoning continuity
- Implement ThinkingBlock dataclass with sequence validation
- Store thinking blocks in JSON format for API compatibility  
- Never modify thinking block content (violates Anthropic requirement)
- Track sequence position for ordered restoration
- Associate tool uses with thinking blocks for reasoning continuity

PATTERN: Memory tool implementation with security-first design
- Path traversal prevention using absolute path validation
- Prompt injection sanitization (Claude tags, system commands, role manipulation)
- Comprehensive audit logging to JSONL format
- Memory scope isolation (switch-contexts/, project-contexts/, patterns/, etc.)
- Cross-session learning through MemoryManager class

PATTERN: Unified workflow integration for seamless context switching
- Automatic pause before switch (no explicit /pause needed)
- Context restoration detection when returning to branches
- Project auto-detection using git branch + file access patterns
- Integrated git workflow with thinking block preservation
- Memory learning from every switch operation

PATTERN: PR merge verification to prevent incomplete merges
- Always verify all commits from feature branch are in PR
- Check expected files exist after merge (renames, deletions)
- Create follow-up PR if commits missing
- Document incomplete merge recovery actions
- Prevent confusion about "missing" features

SOLUTION: Anthropic-first research methodology
- Priority 1: Anthropic official documentation (highest authority)
- Priority 2: Claude Cookbook (implementation patterns)
- Priority 3: Implementation patterns (community-validated)
- Cite all sources with URLs for verification
- Weight Anthropic guidance heaviest in decisions

ARCHITECTURE: Three-tier documentation pattern for production applications
- Tier 1: Repository README (lightweight, <200 lines, developer-focused)
- Tier 2: Knowledge base comprehensive docs (architecture/, deployment/, operations/)
- Tier 3: Agent pattern index (pointers with confidence scores)
- Single source of truth with cross-references instead of duplication

ERROR-FIX: Incomplete PR merge â†’ Only 1 of 2 commits merged
- CAUSE: PR merged from specific commit SHA, not branch HEAD
- FIX: Manual cherry-pick missing commits OR follow-up PR
- PREVENTION: Verify all commits in PR before merge, check files after merge

INTEGRATION: Research role prioritization updated
- Added Anthropic docs as highest priority source (always check first)
- Added Claude Cookbook as second highest priority
- Ensures research follows authoritative guidance over community patterns
- Confidence boost +0.10 for Anthropic-first research success

