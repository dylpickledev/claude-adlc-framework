name: PR Completion Gate

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled]

jobs:
  check-completion-decision:
    name: Verify Completion Decision
    runs-on: ubuntu-latest

    steps:
      - name: Check for completion decision
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const labels = pr.labels.map(label => label.name);

            // Check for completion decision labels
            const hasCompleteLabel = labels.includes('claude:complete');
            const hasSkipLabel = labels.includes('claude:skip');
            const hasNoNeedLabel = labels.includes('claude:no-need');

            const decisionMade = hasCompleteLabel || hasSkipLabel || hasNoNeedLabel;

            if (!decisionMade) {
              // Create helpful comment with decision framework
              const comment = `## 🤖 Claude Completion Decision Required

This PR needs a completion decision before it can be merged. Please add one of these labels:

### 📋 **Decision Framework**

**🎯 Add \`claude:complete\` if this PR involves:**
- New agent capabilities or improvements
- Documentation that could be enhanced
- Knowledge extraction opportunities
- Code that needs final polish/optimization
- Cross-system integration patterns worth preserving
- **Project work that requires manual \`/complete\` command**

**⏭️ Add \`claude:skip\` if this PR:**
- Is a simple fix/typo with no learning value
- Contains sensitive information that shouldn't be processed
- Is already comprehensively documented
- Has time constraints that don't allow for completion

**🚫 Add \`claude:no-need\` if this PR:**
- Is a dependency update or automated change
- Contains only configuration/settings changes
- Is a pure deletion with no replacement logic
- Has no documentation or agent improvement potential

### 🔍 **Verification Process**
- \`claude:complete\` now **verifies** manual completion rather than auto-completing
- You must run \`/complete [project-name]\` in Claude Code **before** adding the label
- The workflow checks that the project was properly archived to \`projects/completed/[YYYY-MM]/\`
- This ensures knowledge extraction, agent updates, and proper documentation

### 💰 **Benefits**
- Manual completion preserves all project learnings
- Agent capability improvements for future work
- Proper knowledge extraction and documentation
- No automated API costs - developer controls the process

**👤 Repository maintainers:** You can add the appropriate label to proceed with merge.`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });

              core.setFailed('PR completion decision required. Please add claude:complete, claude:skip, or claude:no-need label.');
            } else {
              console.log('✅ Completion decision made');

              if (hasCompleteLabel) {
                console.log('🤖 PR marked for Claude completion');
              } else if (hasSkipLabel) {
                console.log('⏭️ PR marked to skip completion');
              } else if (hasNoNeedLabel) {
                console.log('🚫 PR marked as no completion needed');
              }
            }