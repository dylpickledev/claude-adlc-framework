name: Manual Issue Investigation

on:
  issues:
    types: [labeled]

jobs:
  investigate-labeled-issue:
    runs-on: ubuntu-latest
    if: contains(github.event.label.name, 'claude-investigate')

    steps:
    - name: Checkout da-agent-hub
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Claude Code
      run: |
        npm install -g @anthropic/claude-code

    - name: Configure Claude Code
      run: |
        echo "${{ secrets.ANTHROPIC_API_KEY }}" | claude auth --stdin

    - name: Investigate specific issue
      run: |
        echo "ğŸ” Investigating issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"

        # Create focused investigation prompt
        cat > investigate_specific_issue.md << EOF
        # Focused dbt Issue Investigation

        Please investigate this specific dbt issue in detail:

        ## Issue Details
        - **Repository**: ${{ github.repository }}
        - **Issue Number**: #${{ github.event.issue.number }}
        - **Title**: ${{ github.event.issue.title }}
        - **URL**: ${{ github.event.issue.html_url }}
        - **Labels**: ${{ join(github.event.issue.labels.*.name, ', ') }}
        - **Created**: ${{ github.event.issue.created_at }}
        - **Updated**: ${{ github.event.issue.updated_at }}

        ## Issue Body
        \`\`\`
        ${{ github.event.issue.body }}
        \`\`\`

        ## Investigation Tasks

        1. **Agent Selection**: Based on the issue content, deploy appropriate agents:
           - For model/test failures: Use dbt-expert
           - For data quality: Use dbt-expert + snowflake-expert
           - For report models: Use tableau-expert + dbt-expert
           - For business logic: Use business-context + dbt-expert
           - For system-wide issues: Use da-architect

        2. **Deep Analysis**:
           - Analyze the error message and context
           - Check related models and dependencies
           - Look for patterns in recent changes
           - Review similar issues across repositories

        3. **Solution Development**:
           - Provide specific fix recommendations
           - Suggest testing approaches
           - Recommend preventive measures
           - Identify any related issues to address

        4. **Follow-up Actions**:
           - Add detailed investigation findings as a comment
           - Suggest appropriate labels or assignments
           - Recommend next steps for the team

        Please start the investigation and provide comprehensive findings.
        EOF

        # Run Claude investigation
        claude chat investigate_specific_issue.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DBT_CLOUD_API_TOKEN: ${{ secrets.DBT_CLOUD_API_TOKEN }}
        DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}

    - name: Add investigation comment
      run: |
        echo "ğŸ“ Investigation completed for issue #${{ github.event.issue.number }}"
        echo "Claude has analyzed the issue and findings should be available in the chat session."