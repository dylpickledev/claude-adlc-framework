name: Claude Central Hub

# Centralized Claude orchestration for cross-repository automation
on:
  repository_dispatch:
    types: [repo-event]
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository for testing'
        required: true
        type: string
      event_type:
        description: 'Event type to simulate'
        required: true
        type: choice
        options:
          - issues
          - pull_request
          - issue_comment
      test_mode:
        description: 'Run in test mode'
        required: false
        type: boolean
        default: true

jobs:
  execute-claude:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout da-agent-hub
        uses: actions/checkout@v4

      - name: Extract Event Context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "source_repo=${{ github.event.client_payload.source_repo }}" >> $GITHUB_OUTPUT
            echo "event_name=${{ github.event.client_payload.event_name }}" >> $GITHUB_OUTPUT
            echo "trigger=dispatch" >> $GITHUB_OUTPUT
            echo "event_data<<EOF" >> $GITHUB_OUTPUT
            echo '${{ toJson(github.event.client_payload) }}' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "source_repo=${{ github.event.inputs.source_repo }}" >> $GITHUB_OUTPUT
            echo "event_name=${{ github.event.inputs.event_type }}" >> $GITHUB_OUTPUT
            echo "trigger=manual" >> $GITHUB_OUTPUT
            echo "test_mode=${{ github.event.inputs.test_mode }}" >> $GITHUB_OUTPUT
            echo "event_data={}" >> $GITHUB_OUTPUT
          fi

          # Extract repo name for directory operations
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SOURCE_REPO="${{ github.event.client_payload.source_repo }}"
          else
            SOURCE_REPO="${{ github.event.inputs.source_repo }}"
          fi

          if [ -n "$SOURCE_REPO" ]; then
            REPO_NAME=$(basename "$SOURCE_REPO")
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
            echo "Extracted repo name: $REPO_NAME from $SOURCE_REPO"
          else
            echo "ERROR: SOURCE_REPO is empty"
            exit 1
          fi

      - name: Setup Repositories Directory
        run: |
          # Create repos directory (mimics what setup.sh does locally)
          mkdir -p repos
          echo "Created repos directory for repository cloning"

      - name: Clone Required Repository
        run: |
          SOURCE_REPO="${{ steps.context.outputs.source_repo }}"
          REPO_NAME="${{ steps.context.outputs.repo_name }}"

          echo "SOURCE_REPO: $SOURCE_REPO"
          echo "REPO_NAME: $REPO_NAME"

          # Validate inputs
          if [ -z "$SOURCE_REPO" ]; then
            echo "ERROR: SOURCE_REPO is empty"
            exit 1
          fi
          if [ -z "$REPO_NAME" ]; then
            echo "ERROR: REPO_NAME is empty"
            exit 1
          fi

          # Read branch from repositories.json (same config setup.sh uses)
          if [ -f "config/repositories.json" ]; then
            BRANCH=$(jq -r ".repos.\"$REPO_NAME\".branch // \"main\"" config/repositories.json)
            echo "Using branch '$BRANCH' from repositories.json for $REPO_NAME"
          else
            BRANCH="main"
            echo "repositories.json not found, defaulting to main branch"
          fi

          cd repos

          # Clone with PAT for push access (needed for creating fix PRs)
          echo "Cloning $SOURCE_REPO (branch: $BRANCH)"
          git clone -b $BRANCH https://x-access-token:${{ secrets.DA_AGENT_HUB_PAT || secrets.GITHUB_TOKEN }}@github.com/$SOURCE_REPO $REPO_NAME

          # Configure git for potential commits
          cd $REPO_NAME
          git config user.name "claude[bot]"
          git config user.email "claude@da-agent-hub.anthropic.com"

          echo "Repository $REPO_NAME cloned and configured"

      - name: Determine Claude Task
        id: task
        run: |
          EVENT_NAME="${{ steps.context.outputs.event_name }}"
          EVENT_DATA='${{ steps.context.outputs.event_data }}'

          # Determine what Claude should do based on the event
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            echo "task=pr_review" >> $GITHUB_OUTPUT
            echo "agent=dbt-expert" >> $GITHUB_OUTPUT
          elif [[ "$EVENT_NAME" == "issues" ]]; then
            if [[ "$EVENT_DATA" == *"opened"* ]]; then
              echo "task=classify_issue" >> $GITHUB_OUTPUT
              echo "agent=github-sleuth-expert" >> $GITHUB_OUTPUT
            else
              echo "task=update_issue" >> $GITHUB_OUTPUT
              echo "agent=issue-lifecycle-expert" >> $GITHUB_OUTPUT
            fi
          elif [[ "$EVENT_NAME" == "issue_comment" ]]; then
            if [[ "$EVENT_DATA" == *"@claude fix"* ]] || [[ "$EVENT_DATA" == *"@claude create PR"* ]]; then
              echo "task=create_fix_pr" >> $GITHUB_OUTPUT
              echo "agent=dbt-expert" >> $GITHUB_OUTPUT
            elif [[ "$EVENT_DATA" == *"@claude investigate"* ]]; then
              echo "task=investigate" >> $GITHUB_OUTPUT
              echo "agent=github-sleuth-expert" >> $GITHUB_OUTPUT
            else
              echo "task=respond" >> $GITHUB_OUTPUT
              echo "agent=github-sleuth-expert" >> $GITHUB_OUTPUT
            fi
          else
            echo "task=general_analysis" >> $GITHUB_OUTPUT
            echo "agent=github-sleuth-expert" >> $GITHUB_OUTPUT
          fi

          echo "Determined task: $(cat $GITHUB_OUTPUT | grep task= | cut -d'=' -f2)"
          echo "Selected agent: $(cat $GITHUB_OUTPUT | grep agent= | cut -d'=' -f2)"

      - name: Check if Urgent Auto-Resolution Needed
        if: steps.task.outputs.task == 'classify_issue'
        run: |
          # For new critical issues, schedule faster auto-resolution check
          if [[ "${{ steps.context.outputs.event_data }}" == *"critical"* ]] || [[ "${{ steps.context.outputs.event_data }}" == *"production"* ]]; then
            echo "Critical issue detected - will trigger expedited resolution check"
            echo "urgent_issue=true" >> $GITHUB_ENV
          fi

      - name: Execute Claude with Full Context
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Claude Central Hub Task Execution

            You are running from da-agent-hub with full access to all specialized agents and the target repository.

            ## Context
            - **Source Repository**: ${{ steps.context.outputs.source_repo }}
            - **Event Type**: ${{ steps.context.outputs.event_name }}
            - **Task**: ${{ steps.task.outputs.task }}
            - **Agent**: ${{ steps.task.outputs.agent }}
            - **Trigger**: ${{ steps.context.outputs.trigger }}

            ## Available Resources
            - Target repository code is in `repos/${{ steps.context.outputs.repo_name }}/`
            - You can use GitHub CLI to operate on the source repository
            - For creating PRs: work in the repos directory, commit, and push

            ## Task Instructions

            ### For PR Reviews (${{ steps.task.outputs.task == 'pr_review' && 'ACTIVE' || 'inactive' }})
            - Analyze the PR changes in the target repository
            - Navigate to repos/${{ steps.context.outputs.repo_name }}/ and examine the code
            - Provide constructive feedback using dbt-expert knowledge
            - Write your detailed analysis to findings.md
            - IMPORTANT: Post your response using GitHub CLI:
              ```
              gh pr comment ${{ github.event.client_payload.pr_number }} --repo ${{ steps.context.outputs.source_repo }} --body-file findings.md
              ```

            ### For Issue Classification (${{ steps.task.outputs.task == 'classify_issue' && 'ACTIVE' || 'inactive' }})
            - Classify the issue using github-sleuth-expert knowledge
            - Navigate to repos/${{ steps.context.outputs.repo_name }}/ to examine related code
            - Determine if it's: transient_failure, code_fix_required, data_quality_issue, infrastructure_issue, or false_positive
            - Write your classification and analysis to findings.md
            - IMPORTANT: Post your response using GitHub CLI:
              ```
              gh issue comment ${{ github.event.client_payload.issue_number }} --repo ${{ steps.context.outputs.source_repo }} --body-file findings.md
              ```

            ### For Comments/Mentions (${{ steps.task.outputs.task == 'respond' && 'ACTIVE' || 'inactive' }})
            - Respond to the @claude mention with helpful analysis
            - Use appropriate specialized knowledge from available agents
            - Navigate to repos/${{ steps.context.outputs.repo_name }}/ if code context is needed
            - Write your response to findings.md
            - IMPORTANT: Reply to the comment thread using GitHub CLI:
              ```
              gh issue comment ${{ github.event.client_payload.issue_number }} --repo ${{ steps.context.outputs.source_repo }} --body-file findings.md
              ```

            ### For Fix PR Creation (${{ steps.task.outputs.task == 'create_fix_pr' && 'ACTIVE' || 'inactive' }})
            - Analyze the issue and implement a fix
            - Navigate to repos/${{ steps.context.outputs.repo_name }}/
            - Create a new branch: `git checkout -b fix/claude-automated-fix-${{ github.event.client_payload.issue_number }}`
            - Make the necessary changes to fix the issue
            - Commit and push the changes with proper attribution
            - Create a PR using: `gh pr create --title "Fix: automated resolution for issue #${{ github.event.client_payload.issue_number }}" --body "Automated fix generated by Claude"`
            - Comment on the original issue with the PR link

            ### For Investigation (${{ steps.task.outputs.task == 'investigate' && 'ACTIVE' || 'inactive' }})
            - Investigate the issue using specialized knowledge
            - Navigate to repos/${{ steps.context.outputs.repo_name }}/ and examine relevant code
            - Look for patterns, related issues, or root causes
            - Write detailed analysis to findings.md
            - IMPORTANT: Post your investigation results using GitHub CLI:
              ```
              gh issue comment ${{ github.event.client_payload.issue_number }} --repo ${{ steps.context.outputs.source_repo }} --body-file findings.md
              ```

            ## Event Data
            ```json
            ${{ steps.context.outputs.event_data }}
            ```

            ## GitHub CLI Authentication
            GitHub CLI is available and authenticated with DA_AGENT_HUB_PAT for cross-repository operations.

            **CRITICAL**: You MUST respond back to the original PR/issue that triggered this dispatch. Write your analysis to findings.md and use the GitHub CLI commands provided above.

            Please execute the appropriate task based on the context above.
        env:
          GITHUB_TOKEN: ${{ secrets.DA_AGENT_HUB_PAT }}
          DBT_CLOUD_API_TOKEN: ${{ secrets.DBT_CLOUD_API_TOKEN }}
          DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}

      - name: Fallback - Ensure Response Posted
        if: always()
        run: |
          SOURCE_REPO="${{ steps.context.outputs.source_repo }}"
          EVENT_NAME="${{ steps.context.outputs.event_name }}"

          # Check if findings.md exists (Claude should have created it)
          if [ ! -f findings.md ]; then
            echo "âš ï¸ No findings.md found - Claude may not have completed the task"
            echo "Creating minimal response..."
            cat > findings.md << 'EOF'
## ðŸ¤– Claude Task Execution Notice

The Claude task was triggered but no detailed findings were generated. This may indicate:
- The task is still in progress
- There was an issue with the analysis
- The specific task type may need manual review

**Task**: ${{ steps.task.outputs.task }}
**Agent**: ${{ steps.task.outputs.agent }}
**Repository**: ${{ steps.context.outputs.source_repo }}

Please check the workflow logs for more details.
EOF
          fi

          # Determine target number and post response if not already posted
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            PR_NUM=$(echo '${{ steps.context.outputs.event_data }}' | jq -r '.pr_number // empty')
            if [[ -n "$PR_NUM" && "$PR_NUM" != "null" ]]; then
              # Check if Claude already posted (look for recent comments)
              RECENT_COMMENTS=$(gh pr view "$PR_NUM" --repo "$SOURCE_REPO" --json comments --jq '.comments[-3:] | map(.body) | join(" ")')
              if [[ ! "$RECENT_COMMENTS" =~ "Claude" ]]; then
                echo "ðŸ“¤ Fallback: Posting findings to PR #$PR_NUM"
                gh pr comment "$PR_NUM" --repo "$SOURCE_REPO" --body-file findings.md
              else
                echo "âœ… Claude already posted to PR #$PR_NUM"
              fi
            fi

          elif [[ "$EVENT_NAME" == "issues" || "$EVENT_NAME" == "issue_comment" ]]; then
            ISSUE_NUM=$(echo '${{ steps.context.outputs.event_data }}' | jq -r '.issue_number // empty')
            if [[ -n "$ISSUE_NUM" && "$ISSUE_NUM" != "null" ]]; then
              # Check if Claude already posted (look for recent comments)
              RECENT_COMMENTS=$(gh issue view "$ISSUE_NUM" --repo "$SOURCE_REPO" --json comments --jq '.comments[-3:] | map(.body) | join(" ")')
              if [[ ! "$RECENT_COMMENTS" =~ "Claude" ]]; then
                echo "ðŸ“¤ Fallback: Posting findings to Issue #$ISSUE_NUM"
                gh issue comment "$ISSUE_NUM" --repo "$SOURCE_REPO" --body-file findings.md
              else
                echo "âœ… Claude already posted to Issue #$ISSUE_NUM"
              fi
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.DA_AGENT_HUB_PAT }}
          DBT_CLOUD_API_TOKEN: ${{ secrets.DBT_CLOUD_API_TOKEN }}
          DBT_CLOUD_ACCOUNT_ID: ${{ secrets.DBT_CLOUD_ACCOUNT_ID }}

      - name: Create Execution Summary
        if: always()
        run: |
          echo "ðŸ¤– Claude Central Hub Execution Complete"
          echo "Repository: ${{ steps.context.outputs.source_repo }}"
          echo "Task: ${{ steps.task.outputs.task }}"
          echo "Agent: ${{ steps.task.outputs.agent }}"
          echo "Trigger: ${{ steps.context.outputs.trigger }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          # Create summary for debugging
          if [ "${{ steps.context.outputs.test_mode }}" = "true" ]; then
            echo "ðŸ§ª Test mode - no real actions taken"
          fi
