# Extended Thinking Implementation Guide

**Created**: 2025-10-15
**Based On**: Anthropic official guidance and Claude Cookbook
**Project**: Enhanced /switch command implementation

---

## Overview

Extended thinking blocks are Claude's internal reasoning process that can be preserved across conversation turns for continuity. This guide documents the implementation patterns from the enhanced /switch command project.

---

## Anthropic Official Guidance

> "You must pass `thinking` blocks back to the API, and you must include the complete unmodified block back to the API."
>
> "The entire sequence of consecutive thinking blocks must match the outputs generated by the model during the original request."

**Key Requirements**:
- Complete thinking blocks preserved without modification
- Sequence position tracking for ordered restoration
- Tool use association for reasoning continuity
- JSON storage format for API compatibility

---

## Implementation Pattern

### ThinkingBlock Data Structure

```python
@dataclass
class ThinkingBlock:
    """Represents a preserved thinking block from Claude's reasoning"""
    content: str              # The actual thinking content
    turn_number: int          # Which conversation turn this occurred in
    timestamp: str            # ISO format timestamp
    sequence_position: int    # Position in consecutive thinking block sequence
    tool_uses: List[str]      # Tool calls that followed this thinking

    def validate(self) -> bool:
        """Validate thinking block completeness per Anthropic constraints"""
        if not self.content or self.turn_number < 0 or self.sequence_position < 0:
            return False
        return True
```

**Validation Rules**:
- Content must not be empty
- Turn number must be non-negative
- Sequence position must be non-negative
- Tool uses can be empty list (no tools called after thinking)

### ConversationContext Integration

```python
@dataclass
class ConversationContext:
    """Complete conversation context for pause/resume"""
    description: str
    timestamp: str
    current_task: str
    progress_made: List[str]
    decisions_made: List[Dict[str, str]]
    next_steps: List[str]
    blockers: List[str]
    relevant_files: List[Dict[str, str]]
    agents_involved: List[Dict[str, str]]
    thinking_blocks: List[ThinkingBlock]  # ‚Üê Extended thinking integration
    session_duration_estimate: str
    conversation_exchanges: int
    key_topics: List[str]
    project_name: Optional[str] = None
```

**Why This Structure**:
- Thinking blocks are just one component of complete context
- All context is preserved together for seamless restoration
- JSON-serializable for API compatibility

---

## Storage Format

### JSON Schema

```json
{
  "description": "Working on feature implementation",
  "timestamp": "2025-10-15T14:30:00",
  "current_task": "Implementing data pipeline",
  "thinking_blocks": [
    {
      "content": "Need to consider data volume implications...",
      "turn_number": 5,
      "timestamp": "2025-10-15T14:28:45",
      "sequence_position": 0,
      "tool_uses": ["query_database", "analyze_schema"]
    },
    {
      "content": "The incremental approach makes more sense because...",
      "turn_number": 5,
      "timestamp": "2025-10-15T14:29:12",
      "sequence_position": 1,
      "tool_uses": []
    }
  ],
  "project_name": "feature-data-pipeline"
}
```

**Key Features**:
- ISO 8601 timestamps for precision
- Consecutive thinking blocks grouped by turn
- Tool use tracking for reasoning continuity
- Project association for context-aware storage

---

## Security Considerations

### Content Sanitization

**Not Applied to Thinking Blocks**: Thinking blocks should be preserved exactly as generated per Anthropic guidance. However, the surrounding context (description, task names, etc.) should be sanitized.

```python
# CORRECT: Sanitize user-provided content, not thinking blocks
sanitized_description = validator.sanitize_content(user_description)

# INCORRECT: Do not sanitize thinking blocks
# thinking_block.content = validator.sanitize_content(thinking_block.content)
```

**Rationale**: Thinking blocks are Claude's internal reasoning, not user input. Modifying them violates Anthropic's requirement for "complete unmodified blocks."

### Storage Location

**Project-Specific**:
```
projects/active/<project-name>/paused-contexts/
```

**Global**:
```
.claude/paused-contexts/
```

Both locations are git-ignored for security (personal thinking preserved locally only).

---

## Usage Patterns

### Saving Context with Thinking Blocks

```python
from context_manager import ContextManager, ConversationContext, ThinkingBlock

manager = ContextManager()

# Create thinking blocks (in practice, extracted from conversation)
thinking_blocks = [
    ThinkingBlock(
        content="Analyzing the data flow requirements...",
        turn_number=3,
        timestamp=datetime.now().isoformat(),
        sequence_position=0,
        tool_uses=["read_schema", "query_data"]
    )
]

# Create complete context
context = ConversationContext(
    description="Pausing work on data pipeline",
    timestamp=datetime.now().isoformat(),
    current_task="Building ETL for customer data",
    progress_made=["Created schema", "Implemented extraction"],
    decisions_made=[{
        "description": "Using incremental loading",
        "rationale": "Reduces processing time",
        "implications": "Need watermark tracking"
    }],
    next_steps=["Add transformation logic"],
    blockers=[],
    relevant_files=[{"path": "pipelines/etl.py", "reason": "Main implementation"}],
    agents_involved=[],
    thinking_blocks=thinking_blocks,  # ‚Üê Extended thinking preserved
    session_duration_estimate="2 hours",
    conversation_exchanges=12,
    key_topics=["ETL", "incremental loading"]
)

# Save with thinking blocks
filepath = manager.save_context(context)
```

### Restoring Context with Thinking Blocks

```python
# Load context
loaded_context = manager.load_context(filepath)

# Access thinking blocks
for block in loaded_context.thinking_blocks:
    print(f"Turn {block.turn_number}, Position {block.sequence_position}")
    print(f"Thinking: {block.content}")
    print(f"Tools used: {block.tool_uses}")
```

---

## Integration with /switch and /pause

### Automatic Context Preservation

The enhanced `/switch` command automatically preserves thinking blocks:

```bash
./scripts/switch.sh feature-new-work

# Internally:
# 1. Detect active project
# 2. Create ConversationContext with thinking blocks
# 3. Save to project-specific or global location
# 4. Execute git workflow
# 5. Provide resume guidance
```

### Resume Detection

When switching back to a branch:

```bash
./scripts/switch.sh feature-previous-work

# Output:
# üìã Previous context found for feature-previous-work
# Location: projects/active/feature-previous-work/paused-contexts/2025-10-15-14-30.json
#
# To resume with full context (including thinking blocks):
# Say to Claude: 'Continue from 2025-10-15-14-30.json'
```

---

## Performance Benefits

Based on Anthropic official measurements:

| Feature | Performance Improvement | Source |
|---------|------------------------|--------|
| Context editing + memory | **39% improvement** | Anthropic News |
| Extended thinking continuity | **Reasoning consistency** | Extended Thinking Docs |
| Token reduction | **84% in 100-turn evals** | Anthropic Research |

**Key Benefit**: Maintaining reasoning continuity across switches eliminates "context reset" where Claude has to re-establish understanding of complex problems.

---

## Limitations and Future Work

### Current Limitations

1. **Manual Extraction**: Thinking blocks currently extracted manually from conversation
2. **No Claude API Integration**: Requires API access for automatic extraction
3. **Placeholder Token Counting**: Token estimation not yet implemented

### Future Enhancements

1. **Claude API Integration**: Direct conversation analysis and thinking extraction
2. **Automated Token Counting**: Using tiktoken for accurate context window management
3. **Thinking Block Search**: Query historical thinking for similar problem patterns
4. **Cross-Project Learning**: Identify thinking patterns that recur across projects

---

## References

### Anthropic Official Documentation
- **Extended Thinking**: https://docs.claude.com/en/docs/build-with-claude/extended-thinking
- **Claude Code Best Practices**: https://www.anthropic.com/engineering/claude-code-best-practices
- **Context Management**: https://www.anthropic.com/news/context-management

### Implementation Files
- **Core Library**: `scripts/lib/context_manager.py` (ThinkingBlock, ConversationContext)
- **Enhanced Switch**: `scripts/switch.sh` (automatic thinking preservation)
- **Enhanced Pause**: `scripts/pause.sh` (standalone context preservation)
- **Library Docs**: `scripts/lib/README.md` (complete API reference)

---

## Success Criteria

‚úÖ **Successful implementation includes**:
- ThinkingBlock dataclass with validation
- Complete unmodified block preservation per Anthropic guidance
- Sequence position tracking for ordered restoration
- Tool use association for reasoning continuity
- JSON storage format for API compatibility
- Security validation for surrounding context (not thinking blocks themselves)

‚ùå **Common mistakes to avoid**:
- Modifying thinking block content (violates Anthropic requirement)
- Missing sequence position (breaks ordering)
- Not tracking tool uses (loses reasoning continuity)
- Using non-JSON format (API incompatibility)

---

*Extended thinking implementation guide - Following Anthropic official guidance*
*Production-ready pattern from enhanced /switch command project*
